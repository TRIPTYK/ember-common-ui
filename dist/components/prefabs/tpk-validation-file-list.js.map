{"version":3,"file":"tpk-validation-file-list.js","sources":["../../../src/components/prefabs/tpk-validation-file-list.gts"],"sourcesContent":["import { type BaseValidationSignature } from '../base.ts';\nimport TpkValidationErrorsComponent from './tpk-validation-errors.gts';\nimport MandatoryLabelComponent from './mandatory-label.gts';\nimport TpkValidationFileComponent, {\n  type TpkValidationFileComponentSignature,\n} from '../tpk-validation-file.gts';\nimport Component from '@glimmer/component';\nimport { action } from '@ember/object';\nimport { on } from '@ember/modifier';\nimport type { Changeset } from 'ember-immer-changeset';\nimport { fn } from '@ember/helper';\nimport { modifier } from 'ember-modifier';\n\nexport interface TpkValidationFileListPrefabSignature\n  extends BaseValidationSignature {\n  Args: BaseValidationSignature['Args'] &\n    TpkValidationFileComponentSignature['Args'] & {\n      mandatory?: boolean;\n      placeholder?: string;\n      disableDownload?: boolean;\n      onDelete?: (file: File, withoutFiles: File[], allFiles: File[]) => void;\n    };\n  Blocks: {\n    default: [];\n  };\n  Element: HTMLElement;\n}\n\nexport interface FileListSignature {\n  Args: {\n    changeset: Changeset;\n    validationField: string;\n    disableDownload?: boolean;\n    disabled?: boolean;\n    onDelete?: (file: File, withoutFiles: File[], allFiles: File[]) => void;\n  };\n  Blocks: {\n    default: [];\n  };\n  Element: HTMLElement;\n}\n\nconst handleSpaceToOpenListChoice = modifier(function (\n  this: object,\n  element: HTMLElement,\n) {\n  element.addEventListener('keydown', (event) => {\n    if (event.key === ' ') {\n      event.preventDefault();\n      const labelInput = element.parentElement as HTMLLabelElement;\n\n      if (labelInput instanceof HTMLLabelElement) {\n        labelInput.click();\n      }\n    }\n  });\n});\n\nexport default class TpkValidationFileListComponent extends Component<TpkValidationFileListPrefabSignature> {\n  @action\n  handleDrop(event: DragEvent) {\n    event.preventDefault();\n    event.stopPropagation();\n\n    if (this.args.disabled) return;\n\n    let filesFromDrop = event.dataTransfer?.files;\n\n    if (filesFromDrop && filesFromDrop.length > 0) {\n      const files: File[] = Array.from(filesFromDrop);\n\n      if (this.args.onChange) {\n        return this.args.onChange(files);\n      }\n      const currentFiles = this.args.changeset.get(\n        this.args.validationField,\n      ) as File[];\n      return this.args.changeset.set(this.args.validationField, [\n        ...currentFiles,\n        ...files,\n      ]);\n    }\n  }\n\n  <template>\n    <TpkValidationFileComponent\n      @label={{@label}}\n      @disabled={{@disabled}}\n      @changeEvent={{@changeEvent}}\n      @onChange={{@onChange}}\n      @mandatory={{@mandatory}}\n      @validationField={{@validationField}}\n      @changeset={{@changeset}}\n      @multiple={{true}}\n      @requiredFields={{@requiredFields}}\n      as |V|\n    >\n      <V.Label\n        class='tpk-file-list-container'\n        data-has-error='{{V.hasError}}'\n        anchorScrollUp={{@validationField}}\n        data-test-tpk-prefab-file-list-container\n        ...attributes\n      >\n        <MandatoryLabelComponent @label={{@label}} class='tpk-label' />\n        <V.Input class='tpk-file-list-input' data-test-tpk-file-list-input />\n        <div\n          class='tpk-file-list-placeholder-container\n            {{if @disabled \"disabled\"}}'\n          tabindex='0'\n          {{handleSpaceToOpenListChoice}}\n          {{on 'drop' this.handleDrop}}\n        >\n          <img\n            src={{if @disabled '/block.svg' '/upload.svg'}}\n            alt={{if @disabled 'block' 'upload'}}\n            class='tpk-file-list-placeholder-icon'\n          />\n          {{#unless @disabled}}\n            <div class='tpk-file-list-placeholder'>\n              {{@placeholder}}\n            </div>\n          {{/unless}}\n        </div>\n        <TpkValidationErrorsComponent\n          class='tpk-validation-errors'\n          @errors={{V.errors}}\n        />\n      </V.Label>\n      <FileListComponent\n        @onDelete={{@onDelete}}\n        @changeset={{@changeset}}\n        @validationField={{@validationField}}\n        @disableDownload={{@disableDownload}}\n        @disabled={{@disabled}}\n      />\n    </TpkValidationFileComponent>\n  </template>\n}\n\nexport class FileListComponent extends Component<FileListSignature> {\n  changesetGet = (path: string): File[] => {\n    return this.args.changeset.get(path) as File[];\n  };\n\n  startWith = (str: string, start: string) => {\n    return str.startsWith(start);\n  };\n\n  setImagePreview = (file: File): string => {\n    return URL.createObjectURL(file);\n  };\n\n  getSize = (bytes: number): string => {\n    if (bytes === 0) return '0 Bytes';\n\n    const k = 1024;\n    const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB'];\n    const i = Math.floor(Math.log(bytes) / Math.log(k));\n\n    return `${parseFloat((bytes / Math.pow(k, i)).toFixed(2))} ${sizes[i]}`;\n  };\n\n  @action\n  deleteFile(fileToDelete: File) {\n    const currentFiles = this.args.changeset.get(\n      this.args.validationField,\n    ) as File[];\n    const updatedFiles = currentFiles.filter((file) => file !== fileToDelete);\n    if (this.args.onDelete) {\n      return this.args.onDelete(fileToDelete, updatedFiles, currentFiles);\n    }\n    this.args.changeset.set(this.args.validationField, updatedFiles);\n  }\n\n  async downloadFile(file: File) {\n    if (window.open) {\n      window.open(URL.createObjectURL(file));\n    }\n  }\n\n  <template>\n    <div class='tpk-file-list-list {{if @disabled \"disabled\"}}'>\n      {{#each (this.changesetGet @validationField) as |file|}}\n        <div class='tpk-file-list-list-item'>\n          <div class='tpk-file-list-list-item-preview'>\n            {{#if (this.startWith file.type 'image/')}}\n              <img src={{this.setImagePreview file}} alt={{file.name}} />\n            {{else}}\n              <img src='/document.svg' alt='document' />\n            {{/if}}\n          </div>\n          <div class='tpk-file-list-list-item-content'>\n            <h4 class='tpk-file-list-list-item-content-name'>\n              {{file.name}}\n            </h4>\n            <h5 class='tpk-file-list-list-item-content-size'>\n              {{this.getSize file.size}}\n            </h5>\n          </div>\n          <div class='tpk-file-list-list-item-action'>\n            {{#unless @disableDownload}}\n              <button\n                type='button'\n                {{on 'click' (fn this.downloadFile file)}}\n                class='tpk-file-list-list-item-action-download'\n              >\n                <img src='/download.svg' alt='download' />\n              </button>\n            {{/unless}}\n            {{#unless @disabled}}\n              <button\n                type='button'\n                {{on 'click' (fn this.deleteFile file)}}\n                class='tpk-file-list-list-item-action-delete'\n              >\n                <img src='/delete.svg' alt='delete' />\n              </button>\n            {{/unless}}\n          </div>\n        </div>\n      {{/each}}\n    </div>\n  </template>\n}\n"],"names":["handleSpaceToOpenListChoice","modifier","element","addEventListener","event","key","preventDefault","labelInput","parentElement","HTMLLabelElement","click","TpkValidationFileListComponent","Component","handleDrop","stopPropagation","args","disabled","filesFromDrop","dataTransfer","files","length","Array","from","onChange","currentFiles","changeset","get","validationField","set","setComponentTemplate","precompileTemplate","strictMode","scope","TpkValidationFileComponent","MandatoryLabelComponent","on","TpkValidationErrorsComponent","FileListComponent","_TpkValidationFileListComponent","_applyDecoratedDescriptor","_class2","prototype","action","Object","getOwnPropertyDescriptor","constructor","_defineProperty","path","str","start","startsWith","file","URL","createObjectURL","bytes","k","sizes","i","Math","floor","log","parseFloat","pow","toFixed","deleteFile","fileToDelete","updatedFiles","filter","onDelete","downloadFile","window","open","fn","_FileListComponent","_class"],"mappings":"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"}