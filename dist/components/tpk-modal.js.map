{"version":3,"file":"tpk-modal.js","sources":["../../src/components/tpk-modal.gts"],"sourcesContent":["import { getOwner } from '@ember/application';\nimport type ApplicationInstance from '@ember/application/instance';\nimport { assert } from '@ember/debug';\nimport { action } from '@ember/object';\nimport { service } from '@ember/service';\nimport Component from '@glimmer/component';\nimport { modifier } from 'ember-modifier';\nimport DialogLayerService from '../services/dialog-layer.ts';\nimport { guidFor } from '@ember/object/internals';\nimport type { WithBoundArgs } from '@glint/template';\nimport TpkModalContentComponent from './tpk-modal/content.gts';\nimport didInsert from '@ember/render-modifiers/modifiers/did-insert';\nimport willDestroy from '@ember/render-modifiers/modifiers/will-destroy';\nimport { hash } from '@ember/helper';\n\nexport interface TpkModalComponentArgs {\n  isOpen: boolean;\n  onClose: () => unknown;\n  outsideClickHandler?: (e: MouseEvent | TouchEvent) => unknown;\n  title?: string;\n\n}\n\ninterface TpkModalEnv {\n  modal: {\n    id?: string;\n  };\n}\n\nexport interface TpkModalComponentSignature {\n  Args: TpkModalComponentArgs;\n  Element: HTMLDivElement;\n  Blocks: {\n    default: [\n      {\n        Content: WithBoundArgs<\n          typeof TpkModalContentComponent,\n          'title' | 'onClose'  | 'outsideClickHandler'\n        >;\n        isOnTop: boolean;\n        isOpen: boolean;\n        onClose: () => unknown;\n        guid: string;\n      },\n    ];\n  };\n}\n\nexport default class TpkModalComponent extends Component<TpkModalComponentSignature> {\n  @service declare dialogLayer: DialogLayerService;\n\n  guid = guidFor(this);\n\n  constructor(owner: unknown, args: TpkModalComponentArgs) {\n    super(owner, args);\n    assert('Modal initialized without @onClose', args.onClose !== undefined);\n    assert('Modal @title is mandatory', args.title !== undefined);\n  }\n\n  get isOnTop() {\n    return this.dialogLayer.hasOpenChild(this.guid) === false;\n  }\n\n  handleEscapeKey = modifier(\n    (_element, [isOpen, onClose]: [boolean, () => void]) => {\n      const handler = (event: KeyboardEvent) => {\n        if (event.key !== 'Escape') return;\n        if (!isOpen) return;\n\n        if (this.isOnTop) {\n          event.preventDefault();\n          event.stopImmediatePropagation();\n          onClose();\n        }\n      };\n\n      window.addEventListener('keyup', handler);\n\n      return () => {\n        window.removeEventListener('keyup', handler);\n      };\n    },\n  );\n\n  @action\n  outsideClickHandler(e: MouseEvent | TouchEvent) {\n    if (!this.isOnTop) return false;\n    if (this.args.outsideClickHandler) {\n      if (!this.args.outsideClickHandler(e)) {\n        this.args.onClose();\n        return false;\n      }\n      return true;\n    }\n    this.args.onClose();\n    return false;\n  }\n\n  @action\n  updateStack() {\n    this.dialogLayer.add(this.guid);\n  }\n\n  @action\n  willDestroyNode(): void {\n    this.dialogLayer.remove(this.guid);\n    return super.willDestroy();\n  }\n\n  @action\n  close() {\n    if (!this.isOnTop) return;\n    this.args.onClose();\n  }\n\n  get modalKey(): string {\n    const config = (getOwner(this) as ApplicationInstance).resolveRegistration(\n      'config:environment',\n    ) as TpkModalEnv;\n    return config['modal']?.id ?? 'tpk-modal';\n  }\n\n  get modalContainer(): Element {\n    const element = document.getElementById(this.modalKey);\n    if (!element) throw new Error(`Modal container ${this.modalKey} not found`);\n\n    return element;\n  }\n\n  <template>\n    {{#if @isOpen}}\n      {{#in-element this.modalContainer insertBefore=null}}\n        <div\n          {{this.handleEscapeKey @isOpen this.close}}\n          {{didInsert this.updateStack}}\n          {{willDestroy this.willDestroyNode}}\n          class='tpk-modal'\n          ...attributes\n        >\n          {{yield\n            (hash\n              Content=(component\n                TpkModalContentComponent\n                title=@title\n                onClose=this.close\n                outsideClickHandler=this.outsideClickHandler\n              )\n              isOpen=@isOpen\n              isOnTop=this.isOnTop\n              onClose=this.close\n              guid=this.guid\n            )\n          }}\n        </div>\n      {{/in-element}}\n    {{/if}}\n  </template>\n}\n"],"names":["TpkModalComponent","Component","constructor","owner","args","_initializerDefineProperty","_descriptor","_defineProperty","guidFor","modifier","_element","isOpen","onClose","handler","event","key","isOnTop","preventDefault","stopImmediatePropagation","window","addEventListener","removeEventListener","assert","undefined","title","dialogLayer","hasOpenChild","guid","outsideClickHandler","e","updateStack","add","willDestroyNode","remove","willDestroy","close","modalKey","config","getOwner","resolveRegistration","id","modalContainer","element","document","getElementById","Error","setComponentTemplate","precompileTemplate","strictMode","scope","didInsert","hash","TpkModalContentComponent","_TpkModalComponent","_applyDecoratedDescriptor","_class","prototype","service","configurable","enumerable","writable","initializer","action","Object","getOwnPropertyDescriptor"],"mappings":"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"}