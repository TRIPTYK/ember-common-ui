{"version":3,"file":"table.js","sources":["../../../src/components/tpk-table-generic/table.gts"],"sourcesContent":["import Component from '@glimmer/component';\nimport { service } from '@ember/service';\nimport { tracked } from 'tracked-built-ins';\nimport type Store from '@ember-data/store';\nimport type ArrayProxy from '@ember/array/proxy';\nimport { action } from '@ember/object';\n// eslint-disable-next-line ember/use-ember-data-rfc-395-imports\nimport type ModelRegistry from 'ember-data/types/registries/model';\nimport { waitFor } from '@ember/test-waiters';\nimport type { WithBoundArgs } from '@glint/template';\nimport TableGenericBodyComponent from './body.gts';\nimport TableGenericHeaderComponent from './header.gts';\nimport TableGenericFooterComponent from './footer.gts';\n// @ts-expect-error missing types\nimport YetiTable from 'ember-yeti-table/components/yeti-table';\nimport { hash } from '@ember/helper';\nimport LoadingIndicator from '../tpk-loading-indicator.gts';\n\nexport interface SortData {\n  prop: string;\n  direction: string;\n}\nexport interface FilterData {\n  filter: string;\n  filterUsing?: string;\n  columnFilters: { filter: string; fitlerUsing: string }[];\n}\nexport interface PaginationData {\n  pageSize: number;\n  pageNumber: number;\n  pageStart: number;\n  pageEnd: number;\n  isFirstPage: boolean;\n  isLastPage: boolean;\n  totalRows: number;\n  totalPages: number;\n}\n\nexport interface TableLoadDataApi {\n  paginationData: PaginationData;\n  sortData: SortData[];\n  filterData: FilterData;\n  filterRole: {\n    filter: string;\n  };\n}\n\nexport interface TableApi {\n  reloadData: () => void;\n}\n\ninterface TableGenericTableArgs {\n  entity: string;\n  relationships?: string;\n  pageSizes?: number[];\n  pageSize?: number;\n  filterText?: string;\n  // eslint-disable-next-line no-unused-vars\n  registerApi?: (api: TableApi) => unknown;\n  rowClick?: (element?:unknown, e?:Event) => void;\n  additionalFilters?: Record<string, unknown>;\n  defaultSortColumn?: string;\n}\n\nexport interface TableGenericTableSignature {\n  Args: TableGenericTableArgs;\n  Element: HTMLDivElement;\n  Blocks: {\n    default: [\n      {\n        Body: WithBoundArgs<\n          typeof TableGenericBodyComponent,\n          'table' | 'rowClick' | 'registerActionMenu'\n        >;\n        Header: WithBoundArgs<\n          typeof TableGenericHeaderComponent,\n          'table' | 'hasActionMenu'\n        >;\n        Footer: WithBoundArgs<\n          typeof TableGenericFooterComponent,\n          'table' | 'pageSizes' | 'hasActionMenu'\n        >;\n      },\n    ];\n  };\n}\n\nexport default class TableGenericTableComponent<\n  K extends keyof ModelRegistry,\n> extends Component<TableGenericTableSignature> {\n  @service declare store: Store;\n  @tracked totalRows?: number;\n\n  public get pageSize(): number {\n    return this.args.pageSize || 30;\n  }\n\n  public get relationships(): string | undefined {\n    return this.args.relationships;\n  }\n\n  get additionalFilters() {\n    return this.args.additionalFilters ?? {};\n  }\n\n  @action\n  registerApi(api: TableApi) {\n    this.args.registerApi?.(api);\n  }\n\n  @action\n  @waitFor\n  async loadData(data: TableLoadDataApi): Promise<never> {\n    const sortString = this.getSortString(data.sortData);\n\n    const queryOptions = this.buildQueryOptions(\n      this.relationships,\n      this.additionalFilters,\n      data.filterData,\n      data.paginationData,\n      sortString,\n    );\n\n    const array = await this.store.query(this.args.entity as never, queryOptions);\n\n    this.totalRows = (\n      array as unknown as ArrayProxy<K> & {\n        meta: { fetched: number; total: number };\n      }\n    ).meta.total;\n\n    return array as never;\n  }\n\n  private getSortString(sortData: SortData[]): string {\n    return sortData\n      .map(\n        (sortField) =>\n          `${sortField.direction === 'asc' ? '' : '-'}${sortField.prop}`,\n      )\n      .join(',');\n  }\n\n  @tracked hasActionMenu = false;\n\n  @action registerActionMenu() {\n    this.hasActionMenu = true;\n  }\n\n  private buildQueryOptions(\n    relationships: string | undefined,\n    additionalFilters: Record<string, unknown>,\n    filterData: FilterData | undefined,\n    paginationData: PaginationData,\n    sortString?: string,\n  ) {\n    return {\n      include: relationships,\n      filter: {\n        search: filterData?.filter,\n        ...additionalFilters,\n      },\n      page: {\n        size: paginationData.pageSize,\n        number: paginationData.pageNumber,\n      },\n      sort: sortString || this.args.defaultSortColumn || '-updatedAt',\n    };\n  }\n\n  <template>\n    <YetiTable\n      class='tpk-table-generic'\n      @loadData={{this.loadData}}\n      @totalRows={{this.totalRows}}\n      @filter={{@filterText}}\n      @pagination={{true}}\n      @registerApi={{this.registerApi}}\n      @pageSize={{this.pageSize}}\n      data-test-table\n      ...attributes\n      as |table|\n    >\n      {{yield\n        (hash\n          Header=(component\n            TableGenericHeaderComponent table=table hasActionMenu=this.hasActionMenu\n          )\n          Body=(component\n            TableGenericBodyComponent\n            table=table\n            rowClick=@rowClick\n            registerActionMenu=this.registerActionMenu\n          )\n          Footer=(component\n            TableGenericFooterComponent\n            table=table\n            pageSizes=@pageSizes\n            hasActionMenu=this.hasActionMenu\n          )\n        )\n      }}\n      {{#if table.isLoading}}\n        <LoadingIndicator />\n      {{/if}}\n    </YetiTable>\n  </template>\n}\n"],"names":["TableGenericTableComponent","_class","_TableGenericTableComponent","Component","constructor","args","_initializerDefineProperty","_descriptor","_descriptor2","_descriptor3","pageSize","relationships","additionalFilters","registerApi","api","loadData","data","sortString","getSortString","sortData","queryOptions","buildQueryOptions","filterData","paginationData","array","store","query","entity","totalRows","meta","total","map","sortField","direction","prop","join","registerActionMenu","hasActionMenu","include","filter","search","page","size","number","pageNumber","sort","defaultSortColumn","setComponentTemplate","precompileTemplate","strictMode","scope","YetiTable","hash","TableGenericHeaderComponent","TableGenericBodyComponent","TableGenericFooterComponent","LoadingIndicator","_applyDecoratedDescriptor","prototype","service","configurable","enumerable","writable","initializer","tracked","action","Object","getOwnPropertyDescriptor","waitFor"],"mappings":"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"}