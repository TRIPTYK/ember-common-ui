{"version":3,"file":"validate-and-map.js","sources":["../../src/utils/validate-and-map.ts"],"sourcesContent":["import type { Schema } from 'yup';\nimport { ValidationError } from 'yup';\nimport { type ValidationError as ChangesetValidationError } from 'ember-immer-changeset';\n\nexport async function validateAndMapErrors<T extends Schema>(\n  schema: T,\n  dto: unknown,\n): Promise<ChangesetValidationError[]> {\n  try {\n    await schema.validate(dto, { abortEarly: false });\n    return [];\n  } catch (e) {\n    return applyErrors(e);\n  }\n}\n\nexport async function validateOneAndMapErrors<T extends Schema>(\n  path: string,\n  schema: T,\n  dto: unknown,\n): Promise<ChangesetValidationError[]> {\n  try {\n    await schema.validateAt(dottedPathToJsonPath(path), dto, {\n      abortEarly: false,\n      recursive: false,\n    });\n    return [];\n  } catch (e) {\n    return applyErrors(e);\n  }\n}\n\nfunction applyErrors(e: unknown) {\n  if (e instanceof ValidationError) {\n    const errs = e.inner.reduce((mergedErrors, e) => {\n      const path = jsonPathToDottedPath(e.path ?? '');\n      mergedErrors.push({\n        message: e.message,\n        params: e.params,\n        key: path,\n        value: e.value,\n        originalValue: '',\n      });\n      return mergedErrors;\n    }, [] as ChangesetValidationError[]);\n    return errs;\n  }\n  return [];\n}\n\nexport function jsonPathToDottedPath(e: string) {\n  return e.replaceAll('\"', '').replace(/(\\w+)\\[(\\d+)\\]/g, '$1.$2');\n}\n\nexport function dottedPathToJsonPath(e: string) {\n  return e.replaceAll('\"', '').replace(/(\\w+)\\.(\\d+)/g, '$1[$2]');\n}\n"],"names":["validateAndMapErrors","schema","dto","validate","abortEarly","e","applyErrors","validateOneAndMapErrors","path","validateAt","dottedPathToJsonPath","recursive","ValidationError","errs","inner","reduce","mergedErrors","jsonPathToDottedPath","push","message","params","key","value","originalValue","replaceAll","replace"],"mappings":";;;AAIO,eAAeA,oBAAoBA,CACxCC,MAAS,EACTC,GAAY,EACyB;EACrC,IAAI;AACF,IAAA,MAAMD,MAAM,CAACE,QAAQ,CAACD,GAAG,EAAE;AAAEE,MAAAA,UAAU,EAAE,KAAA;AAAM,KAAC,CAAC,CAAA;AACjD,IAAA,OAAO,EAAE,CAAA;GACV,CAAC,OAAOC,CAAC,EAAE;IACV,OAAOC,WAAW,CAACD,CAAC,CAAC,CAAA;AACvB,GAAA;AACF,CAAA;AAEO,eAAeE,uBAAuBA,CAC3CC,IAAY,EACZP,MAAS,EACTC,GAAY,EACyB;EACrC,IAAI;IACF,MAAMD,MAAM,CAACQ,UAAU,CAACC,oBAAoB,CAACF,IAAI,CAAC,EAAEN,GAAG,EAAE;AACvDE,MAAAA,UAAU,EAAE,KAAK;AACjBO,MAAAA,SAAS,EAAE,KAAA;AACb,KAAC,CAAC,CAAA;AACF,IAAA,OAAO,EAAE,CAAA;GACV,CAAC,OAAON,CAAC,EAAE;IACV,OAAOC,WAAW,CAACD,CAAC,CAAC,CAAA;AACvB,GAAA;AACF,CAAA;AAEA,SAASC,WAAWA,CAACD,CAAU,EAAE;EAC/B,IAAIA,CAAC,YAAYO,eAAe,EAAE;AAChC,IAAA,MAAMC,IAAI,GAAGR,CAAC,CAACS,KAAK,CAACC,MAAM,CAAC,CAACC,YAAY,EAAEX,CAAC,KAAK;MAC/C,MAAMG,IAAI,GAAGS,oBAAoB,CAACZ,CAAC,CAACG,IAAI,IAAI,EAAE,CAAC,CAAA;MAC/CQ,YAAY,CAACE,IAAI,CAAC;QAChBC,OAAO,EAAEd,CAAC,CAACc,OAAO;QAClBC,MAAM,EAAEf,CAAC,CAACe,MAAM;AAChBC,QAAAA,GAAG,EAAEb,IAAI;QACTc,KAAK,EAAEjB,CAAC,CAACiB,KAAK;AACdC,QAAAA,aAAa,EAAE,EAAA;AACjB,OAAC,CAAC,CAAA;AACF,MAAA,OAAOP,YAAY,CAAA;KACpB,EAAE,EAAgC,CAAC,CAAA;AACpC,IAAA,OAAOH,IAAI,CAAA;AACb,GAAA;AACA,EAAA,OAAO,EAAE,CAAA;AACX,CAAA;AAEO,SAASI,oBAAoBA,CAACZ,CAAS,EAAE;AAC9C,EAAA,OAAOA,CAAC,CAACmB,UAAU,CAAC,GAAG,EAAE,EAAE,CAAC,CAACC,OAAO,CAAC,iBAAiB,EAAE,OAAO,CAAC,CAAA;AAClE,CAAA;AAEO,SAASf,oBAAoBA,CAACL,CAAS,EAAE;AAC9C,EAAA,OAAOA,CAAC,CAACmB,UAAU,CAAC,GAAG,EAAE,EAAE,CAAC,CAACC,OAAO,CAAC,eAAe,EAAE,QAAQ,CAAC,CAAA;AACjE;;;;"}